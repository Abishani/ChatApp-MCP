<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Server - CV Chat & Email</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">MCP Server Dashboard</h1>

        <!-- Status Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Server Status</h2>
            <div id="status" class="text-gray-600">Loading...</div>
        </div>

        <!-- CV Upload Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Upload CV/Resume</h2>
            <div class="flex items-center space-x-4">
                <input type="file" id="cvFile" accept=".pdf,.docx,.txt"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <button onclick="uploadCV()"
                    class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition duration-200">
                    Upload
                </button>
            </div>
            <div id="uploadStatus" class="mt-4"></div>
        </div>

        <!-- CV Chat Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Chat About Your CV</h2>
            <!-- Chat Messages Container -->
            <div id="chatMessages" class="bg-gray-50 rounded-lg p-4 mb-4 h-96 overflow-y-auto space-y-3">
                <div class="text-center text-gray-500 text-sm">
                    Start a conversation about your CV! Try asking about your experience, skills, or education.
                </div>
            </div>

            <!-- Quick Action Buttons -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button onclick="askPredefinedQuestion('What role did I have at my last position?')"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200 text-sm">
                    Last Position
                </button>
                <button onclick="askPredefinedQuestion('What skills do I have?')"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200 text-sm">
                    Skills
                </button>
                <button onclick="askPredefinedQuestion('What is my education background?')"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200 text-sm">
                    Education
                </button>
                <button onclick="askPredefinedQuestion('What companies have I worked for?')"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200 text-sm">
                    Companies
                </button>
            </div>

            <!-- Chat Input -->
            <div class="flex space-x-2">
                <input type="text" id="chatQuestion" placeholder="Ask a question about your CV..."
                    class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    onkeypress="handleChatKeyPress(event)">
                <button onclick="askQuestion()"
                    class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition duration-200">
                    Ask
                </button>
            </div>
        </div>

        <!-- Email Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Send Email Notification</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Recipient Email</label>
                    <input type="email" id="emailRecipient"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="recipient@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                    <input type="text" id="emailSubject"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Email subject">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Body</label>
                    <textarea id="emailBody" rows="4"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Email content..."></textarea>
                </div>
                <button onclick="sendEmail()"
                    class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition duration-200">
                    Send Email
                </button>
                <div id="emailStatus" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';

        // Load status on page load
        window.onload = function () {
            loadStatus();
        };

        async function loadStatus() {
            try {
                const response = await axios.get(`${API_BASE}/`);
                const status = response.data;
                document.getElementById('status').innerHTML = `
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span>Server Status: ${status.status}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 ${status.cv_loaded ? 'bg-green-500' : 'bg-red-500'} rounded-full"></span>
                            <span>CV Loaded: ${status.cv_loaded ? 'Yes' : 'No'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 ${status.email_configured ? 'bg-green-500' : 'bg-yellow-500'} rounded-full"></span>
                            <span>Email Configured: ${status.email_configured ? 'Yes' : 'No (will use mock mode)'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('status').innerHTML = `
                    <div class="flex items-center space-x-2 text-red-600">
                        <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                        <span>Error connecting to server</span>
                    </div>
                `;
            }
        }

        async function uploadCV() {
            const fileInput = document.getElementById('cvFile');
            const file = fileInput.files[0];

            if (!file) {
                showUploadStatus('Please select a file first.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showUploadStatus('Uploading...', 'info');
                const response = await axios.post(`${API_BASE}/upload-cv`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });

                showUploadStatus(response.data.message, 'success');
                loadStatus(); // Refresh status
            } catch (error) {
                const message = error.response?.data?.detail || 'Upload failed';
                showUploadStatus(message, 'error');
            }
        }

        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            const colorClass = type === 'success' ? 'text-green-600' :
                type === 'error' ? 'text-red-600' : 'text-blue-600';
            statusDiv.innerHTML = `<div class="${colorClass}">${message}</div>`;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                askQuestion();
            }
        }

        function askPredefinedQuestion(question) {
            document.getElementById('chatQuestion').value = question;
            askQuestion();
        }

        function addMessageToChat(message, isUser = false, metadata = null) {
            const chatMessages = document.getElementById('chatMessages');

            // Remove welcome message if it exists
            const welcomeMsg = chatMessages.querySelector('.text-center');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-3`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isUser
                    ? 'bg-blue-500 text-white rounded-br-sm'
                    : 'bg-white border border-gray-200 text-gray-800 rounded-bl-sm'
                }`;

            if (isUser) {
                bubbleDiv.innerHTML = `<div class="text-sm">${message}</div>`;
            } else {
                bubbleDiv.innerHTML = `
                    <div class="text-sm">${message}</div>
                    ${metadata ? `<div class="text-xs mt-1 opacity-70">${metadata}</div>` : ''}
                `;
            }

            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex justify-start mb-3';
            typingDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-gray-100 border border-gray-200 text-gray-600 rounded-bl-sm">
                    <div class="flex items-center space-x-1">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                        <span class="text-xs ml-2">Analyzing CV...</span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function askQuestion() {
            const question = document.getElementById('chatQuestion').value.trim();

            if (!question) {
                return;
            }

            try {
                // Add user message to chat
                addMessageToChat(question, true);

                // Clear input immediately
                document.getElementById('chatQuestion').value = '';

                // Show typing indicator
                showTypingIndicator();


                const response = await axios.post(`${API_BASE}/chat`, {
                    question: question
                });

                // Remove typing indicator
                removeTypingIndicator();

                const data = response.data;
                const metadata = `Confidence: ${(data.confidence * 100).toFixed(1)}% • Sources: ${data.source_sections.join(', ') || 'general'}`;

                // Add AI response to chat
                addMessageToChat(data.answer, false, metadata);
            } catch (error) {
                removeTypingIndicator();
                const message = error.response?.data?.detail || 'Error processing question';
                addMessageToChat(`❌ Error: ${message}`, false);
            }
        }

        async function sendEmail() {
            const recipient = document.getElementById('emailRecipient').value.trim();
            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();

            if (!recipient || !subject || !body) {
                showEmailStatus('Please fill in all fields.', 'error');
                return;
            }

            try {
                showEmailStatus('Sending...', 'info');

                const response = await axios.post(`${API_BASE}/send-email`, {
                    recipient: recipient,
                    subject: subject,
                    body: body
                });

                const data = response.data;
                showEmailStatus(data.message, data.success ? 'success' : 'error');

                if (data.success) {
                    // Clear form
                    document.getElementById('emailRecipient').value = '';
                    document.getElementById('emailSubject').value = '';
                    document.getElementById('emailBody').value = '';
                }
            } catch (error) {
                const message = error.response?.data?.detail || 'Error sending email';
                showEmailStatus(message, 'error');
            }
        }

        function showEmailStatus(message, type) {
            const statusDiv = document.getElementById('emailStatus');
            const colorClass = type === 'success' ? 'text-green-600' :
                type === 'error' ? 'text-red-600' : 'text-blue-600';
            statusDiv.innerHTML = `<div class="${colorClass}">${message}</div>`;
        }
    </script>
</body>

</html>